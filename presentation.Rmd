---
title: "A&E Investigation "
subtitle: "Data Science Project"
author: "Binary_Brigade <br> Connor Finlay, Ade Obawole, Murray Bone, Alexander Patton & Cameron"
institute: "University of Edinburgh"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      ratio: "16:9"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      
---

```{r install-package, include = FALSE, eval = FALSE}
# Copy and paste the following code into your console to download and install
# the `xaringan` package that contains all of the code which allows you 
# to create presentation slides in Rmarkdown
install.packages('xaringan')
```


```{r load-packages, include = FALSE}
# Add any additional packages you need to this chunk
library(tidyverse)
library(tidymodels)
library(palmerpenguins)
library(knitr)
library(xaringanthemer)
library(cowplot)
```

```{r setup, include=FALSE}
# For better figure resolution
knitr::opts_chunk$set(fig.retina = 3, dpi = 300, fig.width = 6, fig.asp = 0.618, out.width = "80%")
```

```{r load-data, include=FALSE}
# Load your data here
# adding a and e data
aANDe <- read_csv("data/a5f7ca94-c810-41b5-a7c9-25c18d43e5a4.csv")

# adding covid data
covid_nottidy <- read_csv("data/b5e3fa11-8a85-4946-bbb2-2e800d4e3594.csv")

nhs_workforce_nottidy <- read_csv("data/data.csv") # Reads data collected from the NHS Scotland's Turas system about the total amount of vacancies across NHS Scotland's allied health professions. Latest release as of Nov 13 2023 https://turasdata.nes.nhs.scot/data-and-reports/official-workforce-statistics/all-official-statistics-publications/05-september-2023-workforce/dashboards/nhs-scotland-workforce/?pageid=9984
```
```{r tidying data, include=FALSE}
unique(aANDe$DepartmentType)
unique(aANDe$Country)

 AandE <- aANDe %>% 
  mutate(
    weekend_date_correct = ymd(WeekEndingDate),
    quarter = quarter(weekend_date_correct, with_year = TRUE),
    ) %>% # Gets the date information for each observation into the datetime and quarter format
     select(-c(WeekEndingDate, DepartmentType, Country)
         ) # Removes irrelevant (superceded/the same for all observations) from the data set
 
 Covid <- covid_nottidy %>% 
   mutate(
     weekend_date_correct = ymd(Date)
   ) %>% 
   select(-c(Date))

nhs_workforce <- nhs_workforce_nottidy %>%
  mutate(
    census_date = ymd(`Census date`),
    quarter = quarter(census_date, with_year = TRUE),
    vacancies = `Value (WTE)`
  ) %>%
      select(
        -c(`Census date`,`Value (WTE)`,...3,`Vacancy note`)
      )

 AandE_work <- AandE %>%
    inner_join(
      by = "quarter",
      nhs_workforce
    ) %>%
    group_by(quarter) %>%
      summarise(
        med_pct_within4 = median(PercentageWithin4HoursEpisode),
        vacancies = median(vacancies)
      )
```

```{r include=FALSE}

#Background image
style_xaringan(
  title_slide_background_image = "img/hospital.jpg"
)
```

class: center, middle

## How does A&E activity and external factors relate to waiting times in Scotland, and are there any notable trends or patterns over time?

---

class: inverse, center, middle

# Trends in A&E waiting times 

---

class: middle

The median percentage seen to within 4 hours seems to decrease over time (especially after 2020) - Why?
```{r echo=  FALSE}
AandE %>% 
  mutate(year = year(weekend_date_correct)) %>%
  group_by(year) %>% 
  summarise( 
    med_pct_Within4 = median(PercentageWithin4HoursEpisode) ) %>% 
  ggplot( mapping = aes( x = year,
                         y = med_pct_Within4 
                         ) 
          ) + 
  geom_bar(stat='identity') + 
  theme_bw() +
  labs(title = "Percentage of Wait Time Under Four Hours by Year",
       y = "Median % Seen To Within 4 Hours",
       x = "Year")
par(mar = c(5, 5, 5, 5))
```
---
class: inverse, center, middle

#Why during 2020
---
- To investigate wait times during 2020 we joined a data set that contained information about COVID-19
```{r echo=  FALSE}
Covidgraph <- AandE %>% filter(weekend_date_correct > ym("2020-03"), weekend_date_correct <=
ym("2023-09")) 

p1 <- ggplot(Covidgraph, aes(x = weekend_date_correct,
                        y = NumberOfAttendancesEpisode)) +
  geom_smooth() + labs( y = "number of AandE admissions",
                       x = "date",
                        title = "A and E Admissions by Date During Covid pandemic")

p2 <- ggplot(Covid, aes(x = weekend_date_correct,
                  y = NumberAdmitted)) +
  geom_smooth() + labs(x = "date",
                       y = "number of covid hospitalisations",
                       title = "Number of Covid Hospitalisations by date")
combined_plot <- plot_grid(p1, p2)

print(combined_plot)
```
---
- From this it can be seen that there is an inverse relationship between the number of hospital addmisions for COVID and the number of A and E admissions.
- Suggesting the type of healthcare required for people during COVID lockdowns wasn't A&E. This will have driven down the median waiting time. 
- Hence we can state that COVID levels did have an effect on A&E admissions.
---
class: inverse, center, middle

#Effect of staff levels on A&E waiting times
---
#Method Used to Investigate
-To investigate we joined another PHS data set to the A&E data.
-This data set included information on the quarterly staffing levels in the NHS.
-We fit a linear reggression model to this to establish if there a trend or not.
-FOR CONNOR TO ADD TO
---

#Linear Regression Plotted
```{r linear reg plot, echo = FALSE, warning=FALSE, message=FALSE}
  AandE_work <- AandE %>%
    inner_join(
      by = "quarter",
      nhs_workforce
    ) %>%
    group_by(quarter) %>%
      summarise(
        med_pct_within4 = median(PercentageWithin4HoursEpisode),
        vacancies = median(vacancies)
      )
 p5 <- AandE_work %>%
    ggplot(
      mapping = aes(
        x = vacancies,
        y = med_pct_within4,
        colour = quarter
      )
    ) +
    geom_point() +
    geom_smooth(method='lm') +
    theme_bw() +
   labs( title = "Linear Regression",
         y = "% within 4 hours",
         x = "Vacancies")


print(p5)
```
---
class: inverse, center, middle

#AandE trends by Health Board
---
#Method employed
-FOR CAMERON TO ADD TO
---
#Plot
```{r Cameron Code, include=FALSE}
  #seperating HBT and number of attendances so that categorical variables can be created, turning number of attendences into a numeric form to calculate measures of central tendancy, renaming column to be simpler)
HBTAtten <- AandE %>% 
  select(HBT, NumberOfAttendancesEpisode) %>% 
  rename(NumAttended = NumberOfAttendancesEpisode) %>% 
  mutate(NumAttended = as.numeric(NumAttended))

# View the resulting data frame
print(HBTAtten)

#average number of Attendances to the practice
mean(HBTAtten$NumAttended)
#mean is 833.33

#finding all locations within dataframe
unique(HBTAtten$HBT)

#calculating mean attendances for each HBT
S15 <- HBTAtten %>%
  filter(HBT == "S08000015")
mean(S15$NumAttended)

S16 <- HBTAtten %>%
  filter(HBT == "S08000016")
mean(S16$NumAttended)

S17 <- HBTAtten %>%
  filter(HBT == "S08000017")
mean(S17$NumAttended)

S28 <- HBTAtten %>%
  filter(HBT == "S08000028")
mean(S28$NumAttended)

S19 <- HBTAtten %>%
  filter(HBT == "S08000019")
mean(S19$NumAttended)

S20 <- HBTAtten %>%
  filter(HBT == "S08000020")
mean(S20$NumAttended)

S22 <- HBTAtten %>%
  filter(HBT == "S08000022")
mean(S22$NumAttended)

S32 <- HBTAtten %>%
  filter(HBT == "S08000032")
mean(S32$NumAttended)

S24 <- HBTAtten %>%
  filter(HBT == "S08000015")
mean(S24$NumAttended)

S25 <- HBTAtten %>%
  filter(HBT == "S08000025")
mean(S15$NumAttended)

S26 <- HBTAtten %>%
  filter(HBT == "S08000026")
mean(S26$NumAttended)

S30 <- HBTAtten %>%
  filter(HBT == "S08000030")
mean(S30$NumAttended)

S31 <- HBTAtten %>%
  filter(HBT == "S08000031")
mean(S31$NumAttended)

S28 <- HBTAtten %>%
  filter(HBT == "S08000028")
mean(S28$NumAttended)

S29 <- HBTAtten %>%
  filter(HBT == "S08000029")
mean(S29$NumAttended)

#creating a new dataframe that includes the mean attendances of HBTs
first_column <- c("S08000015", "S08000016", "S08000017", "S08000019", "S08000020", "S08000022", "S08000024", "S08000025", "S08000026", "S08000028", "S08000029", "S08000030", "S08000031", "S08000032")
second_column <- c("988.0455", "561.5078","435.0532", "1163.206", "616.1212", "285.3492", " 988.0455", "118.2772", "139.6851", " 114.2506", "1219.539", "709.4213","1274.071", "1260.387")



MeanAtten <- data.frame(first_column, second_column)
MeanAtten
```



```{r health board plot, echo = FALSE, warning=FALSE, message=FALSE }
#creating graph
ggplot(MeanAtten, aes(x = first_column, y = second_column, fill = first_column)) +
  geom_bar(stat = "identity") +
  labs(title = "Mean Attendances for Health Board Trusts",
       x = "Health Board Trusts",
       y = "Mean Attendances") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
---
class: inverse, center, middle

#Conclusions
---
#Conclusions
- As stress due to COVID increased, the stress on A&E decreased
- ...